require 'open-uri'
Prospectus.extra_dep('file', 'nokogiri')

def upstream_version
  page = Nokogiri::HTML(open('https://www.ruby-lang.org/en/downloads/'))
  table = page.xpath('//*[@id="content"]/ul[2]')
  stable, maint, _ = table.xpath('li')
  fail('Failed to parse stable') unless stable.text.start_with? 'Stable '
  fail('Failed to parse maint') unless maint.text.start_with? 'In security maintenance phase '
  [stable, maint].map do |type|
    type.css('li').map { |x| x.text.split("\n").first.split.last }
  end.flatten.join(', ')
end

UPSTREAM_VERSION = upstream_version

item do
  expected do
    static
    set 'green'
  end

  actual do
    gemnasium
    slug 'akerl/gemplate'
  end

  deps do
    item do
      name 'ruby'

      expected do
        static

        set UPSTREAM_VERSION
      end

      actual do
        static
        set File.read('.circle-ruby').chomp.gsub("\n",', ')
      end
    end
  end
end
